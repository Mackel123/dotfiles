#!/usr/bin/env zsh

# FZF builtin key bindings and completion
[ -f "${XDG_CONFIG_HOME:-$HOME/.config}"/fzf/fzf.zsh ] && source "${XDG_CONFIG_HOME:-$HOME/.config}"/fzf/fzf.zsh

export FD_DEFAULT_OPTS="--hidden --follow --exclude .git"

# Use fd instead of default find
export FZF_DEFAULT_COMMAND="fd $FD_DEFAULT_OPTS"

# Default options when running fzf
# Default bindings:
#   - ctrl-d     :  move cursor half page down
#   - ctrl-u     :  move cursor halp page up
#   - shift-down :  move preview half page down
#   - shift-up   :  move preview half page up
export FZF_DEFAULT_OPTS="--multi \
                         --reverse \
                         --no-mouse \
                         --height 40%\
                         --history /tmp/fzfhistory \
                         --bind 'ctrl-d:half-page-down,ctrl-u:half-page-up,shift-down:preview-half-page-down,shift-up:preview-half-page-up,change:top' \
                         --color=dark \
                         --color=fg:-1,bg:-1,hl:#5fff87,fg+:-1,bg+:-1,hl+:#ffaf5f \
                         --color=info:#af87ff,prompt:#5fff87,pointer:#ff87d7,marker:#ff87d7,spinner:#ff87d7"

# Use fd for FZF completion
# 1). listing files and dirs ($1 is the base path to start search) such as "vim ~/.config/**<TAB>"
_fzf_compgen_path() {
  fd --hidden --follow --exclude ".git" . "$1"
}
# 2). listing dirs such as "cd **<TAB>"
_fzf_compgen_dir() {
  fd --type d --hidden --follow --exclude ".git" . "$1"
}

# Use fd for CTRL-t (paste the selected file or dir onto the command line)
export FZF_CTRL_T_COMMAND="fd $FD_DEFAULT_OPTS"

# Display the full command on the preview window (CTRL-r for command history search)
export FZF_CTRL_R_OPTS="--preview 'echo {}' --preview-window down:3:wrap --bind 'ctrl-y:execute-silent(echo -n {2..} | pbcopy)' --header 'Press CTRL-Y to copy command into clipboard'"

# CTRL-z for cd into the selected dir
bindkey '^z' fzf-cd-widget
export FZF_ALT_C_COMMAND="fd --type d $FD_DEFAULT_OPTS"
export FZF_ALT_C_OPTS="--preview 'tree -C {} | head -200'"

# Utility commands (defined under ../fzfutils/)
#   - f [DIR] [FZF ARGS]:  fzf with an optional directory argument
#   - fo [DIR] [QUERY]:    fzf to open a file via vim (ctrl-v), or via difault application (ctrl-o)
#   - fcd [DIR]:           fzf to cd into a directory under DIR
#   - frg [RG ARGS]:       fzf for rg results and open it via vim
#   - fk:                  fzf to kill a process
#   - fgi:                 fzf to create gitignore files
#   - bf:                  fzf to open a bookmark file via vim
#   - bd:                  fzf to cd into a bookmark directory
fpath+=${0:h}/fzfutils
autoload -Uz ${0:h}/fzfutils/*(.:t)

# Other utils
#   1. npf (npm with fzf, run npf --help to get usage information)
